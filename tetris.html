<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>テトリス</title>
        <style>
            body{
                background: #ddf5ff;
            }
            #container{
                margin: 0 auto;
            }
        </style>
    </head>
    <body onload="init()">
       <div id="container">
        <canvas id="cvs"></canvas>
       </div> 
        <script>
            const blockSize=30;//ブロック1マスの大きさ
            //ボードサイズ
            const boardRow=20;
            const boardCol=10;
            //キャンパス取得
            const cvs = document.getElementById("cvs");
            //2dコンテキスト取得
            const ctx= cvs.getContext("2d");
            //キャンパスサイズ
            const canvasW=blockSize * boardCol;
            const canvasH=blockSize * boardRow;
            cvs.width=canvasW;
            cvs.height=canvasH;
            //コンテナの設定
            const container=document.getElementById("container");
            container.style.width=canvasW + "px" ;

            //tetの1辺の大きさ
            const tetSize=4;
            //T型のtet
            let tet=[
                [0,0,0,0],
                [0,1,0,0],
                [1,1,1,0],
                [0,0,0,0],
            ];

            //テトリミノのオフセット量（何マス分ずれているか）
            let offsetX=0;
            let offsetY=0;

            //ボード本体
            const board = [];

            //描画処理
            const draw=()=>{
                //塗りに黒を設定
                ctx.fillStyle="#000";
                //キャンバスを塗りつぶす(描画したものを一度消すため)
                ctx.fillRect(0,0,canvasW,canvasH);

                //ボードに存在しているブロックを塗る
                for(let y=0;y<boardRow;y++){
                    for(let x=0;x<boardCol;x++){
                        if(board[y][x]){
                            drawBlock(x,y);
                        }
                    }
                }

                //テトリミノの描画
                for(let y=0;y<tetSize;y++){
                    for(let x=0;x<tetSize;x++){
                        //もし、1だったら
                        if(tet[y][x]){
                            drawBlock(offsetX+x,offsetY+y);
                        }
                    }
                }
            };
            //ブロック一つを描画する
            const drawBlock=(x,y)=>{
                let px = x * blockSize;
                let py = y * blockSize;
                //塗りを指定(赤)
                ctx.fillStyle="#f00";
                ctx.fillRect(px,py,blockSize,blockSize);
                //線を設定(黒)
                ctx.strokeStyle="block";
                //線を描画
                ctx.strokeRect(px,py,blockSize,blockSize);
            };

            //指定された方向に移動できるか(x移動量,y移動量)
            const canMove=(dx,dy,nowTet=tet)=>{
                for(let y=0;y<tetSize;y++){
                    for(let x=0;x<tetSize;x++){
                        //その場所にブロックがあれば
                        if(nowTet[y][x]){
                            //ボード座標に変換
                            let nx = offsetX + x + dx;
                            let ny = offsetY + y + dy;
                            if(
                                //調査する座標がボード外だったらできない
                                ny < 0 ||
                                nx < 0 ||
                                ny >= boardRow ||
                                nx >= boardCol ||
                                //移動したいボード上の場所にすでに存在してたらできない
                                board[ny][nx]
                            ){
                                //移動できない
                                return false;
                            }
                        }
                    }
                }
                //移動できる
                return true;
            };

            //ミノの回転
            const createRotateTet=()=>{
                //新しいtetを作る
                let newTet = [];
                for(let y=0;y<tetSize;y++){
                    newTet[y] = [];
                    for(let x=0;x<tetSize;x++){
                        //時計回りに90度回転させる
                        newTet[y][x] = tet[tetSize - 1 -x][y];
                    }
                }
                return newTet;
            };
            //キーの入力
            document.onkeydown=(e)=>{
                switch(e.keyCode){
                    case 37://左
                        if(canMove(-1,0))offsetX--;
                        break;
                    case 38://上
                        if(canMove(0,-1))offsetY--;
                        break;
                    case 39://右
                        if(canMove(1,0))offsetX++;
                        break;
                    case 40://下
                        if(canMove(0,1))offsetY++;
                        break;
                    case 32://space
                        let newTet = createRotateTet();
                        if(canMove(0,0,newTet)){
                            tet = createRotateTet();
                        }
                }
                draw();
            };
            //初期化処理
            const init=()=>{
                //ボード(20*10を0埋め)
                for(let y=0;y<boardRow;y++){
                    board[y] = [];
                    for(let x=0;x<boardCol;x++){
                        board[y][x] = 0;
                    }
                }
                //テスト用
                board[3][5]=1;
                draw();
            }
        </script>
    </body>
</html>